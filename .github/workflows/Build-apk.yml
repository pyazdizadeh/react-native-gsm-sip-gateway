name: Build Android APK (Lightweight, No sdkmanager)

on:
  push:
    branches:
      - "*"

jobs:
  build_android:
    runs-on: ubuntu-latest
    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3Ô∏è‚É£ Install OpenJDK 11 (Runner default usually enough)
      - name: Install JDK
        run: |
          sudo apt update
          sudo apt install -y openjdk-11-jdk
          echo "JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64" >> $GITHUB_ENV

      # 4Ô∏è‚É£ Download command line tools (cmdline-tools)
      - name: Download Android Command-line Tools
        run: |
          mkdir -p $HOME/android-sdk/cmdline-tools
          curl -L -o cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q cmdline-tools.zip -d $HOME/android-sdk/cmdline-tools
          mv $HOME/android-sdk/cmdline-tools/cmdline-tools $HOME/android-sdk/cmdline-tools/latest
          rm cmdline-tools.zip
          echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
          echo "$HOME/android-sdk/cmdline-tools/latest/bin:$PATH" >> $GITHUB_ENV

      # 5Ô∏è‚É£ Download specific NDK manually
      - name: Download NDK r17b
        run: |
          mkdir -p $HOME/android-ndk
          curl -L -o android-ndk.zip https://dl.google.com/android/repository/android-ndk-r17b-linux-x86_64.zip
          unzip -q android-ndk.zip -d $HOME/android-ndk
          rm android-ndk.zip
          echo "NDK_HOME=$HOME/android-ndk/android-ndk-r17b" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$HOME/android-ndk/android-ndk-r17b" >> $GITHUB_ENV

      # 6Ô∏è‚É£ Install NPM dependencies
      - name: Install NPM dependencies
        run: npm ci
        working-directory: telon-gateway-app

      # 7Ô∏è‚É£ Bundle React Native assets
      - name: Bundle React Native
        run: |
          mkdir -p android/app/build/intermediates/assets/release/
          npx react-native bundle \
            --platform android \
            --dev false \
            --entry-file index.js \
            --bundle-output android/app/build/intermediates/assets/release/index.android.bundle \
            --assets-dest android/app/build/intermediates/res/merged/release
        working-directory: telon-gateway-app

      # 8Ô∏è‚É£ Generate random keystore
      - name: Generate random Keystore
        run: |
          KEYSTORE_PATH="telon-gateway-app/android/app/my-release-key.keystore"
          if [ ! -f "$KEYSTORE_PATH" ]; then
            PASSWORD=$(openssl rand -base64 12)
            echo "Random keystore password: $PASSWORD"
            echo "$PASSWORD" >> $GITHUB_ENV
            keytool -genkey -v \
              -keystore "$KEYSTORE_PATH" \
              -alias joolio-key \
              -keyalg RSA -keysize 2048 \
              -validity 10000 \
              -storepass $PASSWORD \
              -keypass $PASSWORD \
              -dname "CN=Mohammad Yazdizadeh, OU=Dev, O=JOOLIO, L=City, S=State, C=US"
          fi

      # 9Ô∏è‚É£ Set versionCode and versionName automatically
      - name: Set APK Version
        run: |
          BUILD_DATE=$(date +%Y%m%d)
          BUILD_NUMBER=$(date +%H%M%S)
          sed -i "s/versionCode [0-9]\+/versionCode $BUILD_NUMBER/" telon-gateway-app/android/app/build.gradle
          sed -i "s/versionName \".*\"/versionName \"$BUILD_DATE-$BUILD_NUMBER\"/" telon-gateway-app/android/app/build.gradle

      # üîü Set application metadata
      - name: Set APK Metadata
        run: |
          MANIFEST_FILE=telon-gateway-app/android/app/src/main/AndroidManifest.xml
          sed -i 's|android:label=".*"|android:label="JOOLIO GSM Gateway"|' $MANIFEST_FILE
          sed -i '/<application / a\
          <meta-data android:name="Author" android:value="Mohammad Yazdizadeh"/>\
          <meta-data android:name="Company" android:value="JOOLIO"/>\
          <meta-data android:name="Website" android:value="https://joolio.me"/>' $MANIFEST_FILE

      # 1Ô∏è‚É£1Ô∏è‚É£ Build APK
      - name: Build Android Release APK
        working-directory: telon-gateway-app/android
        run: |
          chmod +x gradlew
          ./gradlew clean assembleRelease -Pkeystore.password=$PASSWORD

      # 1Ô∏è‚É£2Ô∏è‚É£ Copy APK to dist
      - name: Copy APK
        run: |
          mkdir -p $GITHUB_WORKSPACE/dist
          cp app/build/outputs/apk/release/*.apk "$GITHUB_WORKSPACE/dist/JOOLIO GSM Gateway.apk"

      # 1Ô∏è‚É£3Ô∏è‚É£ Upload APK
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: $GITHUB_WORKSPACE/dist/JOOLIO\ GSM\ Gateway.apk
