name: Build Android APK (JOOLIO GSM Gateway + Versioning)

on:
  push:
    branches:
      - "*"

jobs:
  build_android:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Cache Node modules
      - name: Cache Node.js modules
        uses: actions/cache@v4
        with:
          path: telon-gateway-app/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('telon-gateway-app/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      # 3Ô∏è‚É£ Cache Gradle
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper/
          key: ${{ runner.os }}-gradle-${{ hashFiles('telon-gateway-app/android/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4Ô∏è‚É£ Setup Node.js 18
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 5Ô∏è‚É£ Install OpenJDK 8
      - name: Install OpenJDK 8
        run: |
          sudo apt update
          sudo apt install -y openjdk-8-jdk
          echo "JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64" >> $GITHUB_ENV

      # 6Ô∏è‚É£ Setup Android SDK & NDK
      - name: Setup Android SDK and NDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 19
          ndk-version: 17.2.4988734
          build-tools: 25.2.5

      # 7Ô∏è‚É£ Install NPM dependencies
      - name: Install dependencies
        run: npm ci
        working-directory: telon-gateway-app

      # 8Ô∏è‚É£ Bundle React Native assets
      - name: Bundle React Native assets
        run: |
          mkdir -p android/app/build/intermediates/assets/release/
          npx react-native bundle \
            --platform android \
            --dev false \
            --entry-file index.js \
            --bundle-output android/app/build/intermediates/assets/release/index.android.bundle \
            --assets-dest android/app/build/intermediates/res/merged/release
        working-directory: telon-gateway-app

      # 9Ô∏è‚É£ Generate random keystore
      - name: Generate Random Keystore
        run: |
          KEYSTORE_PATH="telon-gateway-app/android/app/my-release-key.keystore"
          if [ ! -f "$KEYSTORE_PATH" ]; then
            PASSWORD=$(openssl rand -base64 12)
            echo "Random keystore password: $PASSWORD"
            echo "$PASSWORD" >> $GITHUB_ENV
            keytool -genkey -v \
              -keystore "$KEYSTORE_PATH" \
              -alias joolio-key \
              -keyalg RSA -keysize 2048 \
              -validity 10000 \
              -storepass $PASSWORD \
              -keypass $PASSWORD \
              -dname "CN=Mohammad Yazdizadeh, OU=Dev, O=JOOLIO, L=City, S=State, C=US"
          fi

      # üîü Set versionCode and versionName automatically
      - name: Set APK Version
        run: |
          BUILD_DATE=$(date +%Y%m%d)
          BUILD_NUMBER=$(date +%H%M%S)
          sed -i "s/versionCode [0-9]\+/versionCode $BUILD_NUMBER/" telon-gateway-app/android/app/build.gradle
          sed -i "s/versionName \".*\"/versionName \"$BUILD_DATE-$BUILD_NUMBER\"/" telon-gateway-app/android/app/build.gradle
          echo "Set versionCode=$BUILD_NUMBER and versionName=$BUILD_DATE-$BUILD_NUMBER"

      # 1Ô∏è‚É£1Ô∏è‚É£ Set application metadata
      - name: Set APK Metadata
        run: |
          MANIFEST_FILE=telon-gateway-app/android/app/src/main/AndroidManifest.xml
          sed -i 's|android:label=".*"|android:label="JOOLIO GSM Gateway"|' $MANIFEST_FILE
          sed -i '/<application / a\
          <meta-data android:name="Author" android:value="Mohammad Yazdizadeh"/>\
          <meta-data android:name="Company" android:value="JOOLIO"/>\
          <meta-data android:name="Website" android:value="https://joolio.me"/>' $MANIFEST_FILE

      # 1Ô∏è‚É£2Ô∏è‚É£ Build APK
      - name: Build Android Release APK
        working-directory: telon-gateway-app/android
        run: |
          chmod +x gradlew
          ./gradlew clean assembleRelease -Pkeystore.password=$PASSWORD

      # 1Ô∏è‚É£3Ô∏è‚É£ Copy APK with fixed name
      - name: Copy APK to dist
        run: |
          mkdir -p $GITHUB_WORKSPACE/dist
          cp app/build/outputs/apk/release/*.apk "$GITHUB_WORKSPACE/dist/JOOLIO GSM Gateway.apk"
        shell: bash

      # 1Ô∏è‚É£4Ô∏è‚É£ Upload APK artifact
      - name: Upload APK to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: $GITHUB_WORKSPACE/dist/JOOLIO\ GSM\ Gateway.apk

      # 1Ô∏è‚É£5Ô∏è‚É£ Update README with download link
      - name: Update README with APK link
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const artifactName = "android-apk";
            const run_id = process.env.GITHUB_RUN_ID;
            const repo = process.env.GITHUB_REPOSITORY;
            const owner = repo.split('/')[0];
            const repoName = repo.split('/')[1];
            const url = `https://github.com/${owner}/${repoName}/suites/${run_id}/artifacts`;

            const fs = require('fs');
            const readmePath = 'README.md';
            let readme = fs.existsSync(readmePath) ? fs.readFileSync(readmePath, 'utf8') : '';
            const apkLine = `\n[Download Latest APK - JOOLIO GSM Gateway](${url})\n`;
            if (!readme.includes(apkLine)) {
              readme += apkLine;
              fs.writeFileSync(readmePath, readme, 'utf8');
            }
