name: Build Android APK (Node 18, RN Metro Fix)

on:
  push:
    branches:
      - "*"

jobs:
  build_android:
    runs-on: ubuntu-latest
    env:
      ANDROID_HOME: ${{ runner.temp }}/android-sdk
      ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
      JAVA_HOME: /usr/lib/jvm/java-11-openjdk-amd64

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js 18
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3Ô∏è‚É£ Install OpenJDK 11
      - name: Install OpenJDK
        run: sudo apt-get update && sudo apt-get install -y openjdk-11-jdk

      # 4Ô∏è‚É£ Install Android SDK cmdline-tools
      - name: Install Android SDK Command-line Tools
        run: |
          mkdir -p $ANDROID_HOME/cmdline-tools
          curl -L -o cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q cmdline-tools.zip -d $ANDROID_HOME/cmdline-tools
          mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest
          rm cmdline-tools.zip
          echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH

      # 5Ô∏è‚É£ Accept SDK licenses
      - name: Accept SDK licenses
        run: yes | sdkmanager --licenses

      # 6Ô∏è‚É£ Install NDK r17b
      - name: Install Android NDK r17b
        run: |
          mkdir -p $HOME/android-ndk
          curl -L -o android-ndk.zip https://dl.google.com/android/repository/android-ndk-r17b-linux-x86_64.zip
          unzip -q android-ndk.zip -d $HOME/android-ndk
          rm android-ndk.zip
          echo "$HOME/android-ndk/android-ndk-r17b" >> $GITHUB_PATH
          echo "NDK_HOME=$HOME/android-ndk/android-ndk-r17b" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$HOME/android-ndk/android-ndk-r17b" >> $GITHUB_ENV

      # 7Ô∏è‚É£ Validate package.json
      - name: Validate package.json
        run: cat telon-gateway-app/package.json | jq .

      # 8Ô∏è‚É£ Clean node_modules and cache
      - name: Clean node_modules
        run: |
          rm -rf node_modules package-lock.json
          npm cache clean --force
        working-directory: telon-gateway-app

      # 9Ô∏è‚É£ Ensure Metro config
      - name: Setup Metro config
        run: |
          if [ ! -f metro.config.js ]; then
            curl -L -o metro.config.js https://raw.githubusercontent.com/react-native-community/template/main/template/metro.config.js
          fi
        working-directory: telon-gateway-app

      # üîü Install npm dependencies
      - name: Install npm dependencies
        run: npm install
        working-directory: telon-gateway-app

      # 1Ô∏è‚É£1Ô∏è‚É£ Bundle React Native assets
      - name: Bundle React Native assets
        run: |
          mkdir -p android/app/build/intermediates/assets/release/
          npx react-native bundle \
            --platform android \
            --dev false \
            --entry-file index.js \
            --bundle-output android/app/build/intermediates/assets/release/index.android.bundle \
            --assets-dest android/app/build/intermediates/res/merged/release
        working-directory: telon-gateway-app

      # 1Ô∏è‚É£2Ô∏è‚É£ Generate random Keystore
      - name: Generate random Keystore
        run: |
          KEYSTORE_PATH="android/app/my-release-key.keystore"
          if [ ! -f "$KEYSTORE_PATH" ]; then
            PASSWORD=$(openssl rand -base64 12)
            echo "KEYSTORE_PASSWORD=$PASSWORD" >> $GITHUB_ENV
            keytool -genkey -v \
              -keystore "$KEYSTORE_PATH" \
              -alias joolio-key \
              -keyalg RSA -keysize 2048 \
              -validity 10000 \
              -storepass $PASSWORD \
              -keypass $PASSWORD \
              -dname "CN=Mohammad Yazdizadeh, OU=Dev, O=JOOLIO, L=City, S=State, C=US"
          fi
        working-directory: telon-gateway-app

      # 1Ô∏è‚É£3Ô∏è‚É£ Set APK metadata
      - name: Set APK Metadata
        run: |
          MANIFEST_FILE=android/app/src/main/AndroidManifest.xml
          sed -i 's|android:label=".*"|android:label="JOOLIO GSM Gateway"|' $MANIFEST_FILE
          sed -i '/<application / a\
          <meta-data android:name="Author" android:value="Mohammad Yazdizadeh"/>\
          <meta-data android:name="Company" android:value="JOOLIO"/>\
          <meta-data android:name="Website" android:value="https://joolio.me"/>' $MANIFEST_FILE
        working-directory: telon-gateway-app

      # 1Ô∏è‚É£4Ô∏è‚É£ Build APK
      - name: Build Android Release APK
        working-directory: telon-gateway-app/android
        run: |
          chmod +x gradlew
          ./gradlew clean assembleRelease -Pkeystore.password=$KEYSTORE_PASSWORD

      # 1Ô∏è‚É£5Ô∏è‚É£ Copy APK to dist
      - name: Copy APK
        run: |
          mkdir -p $GITHUB_WORKSPACE/dist
          cp app/build/outputs/apk/release/*.apk "$GITHUB_WORKSPACE/dist/JOOLIO GSM Gateway.apk"
        working-directory: telon-gateway-app/android

      # 1Ô∏è‚É£6Ô∏è‚É£ Upload APK
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: $GITHUB_WORKSPACE/dist/JOOLIO\ GSM\ Gateway.apk
