name: Build Android APK (Stable, Node 18, Metro Fix)

on:
  push:
    branches:
      - "*"

jobs:
  build_android: 
    runs-on: ubuntu-latest
    env:
      ANDROID_HOME: $HOME/android-sdk
      ANDROID_SDK_ROOT: $HOME/android-sdk
      JAVA_HOME: /usr/lib/jvm/java-11-openjdk-amd64
      NDK_HOME: $HOME/android-ndk/android-ndk-r17b
      ANDROID_NDK_HOME: $HOME/android-ndk/android-ndk-r17b

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js 18
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3Ô∏è‚É£ Install OpenJDK 11
      - name: Install OpenJDK
        run: |
          sudo apt update
          sudo apt install -y openjdk-11-jdk
          echo "JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64" >> $GITHUB_ENV

      # 4Ô∏è‚É£ Download Android cmdline-tools
      - name: Download Android Command-line Tools
        run: |
          mkdir -p $HOME/android-sdk/cmdline-tools
          curl -L -o cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q cmdline-tools.zip -d $HOME/android-sdk/cmdline-tools
          mv $HOME/android-sdk/cmdline-tools/cmdline-tools $HOME/android-sdk/cmdline-tools/latest
          rm cmdline-tools.zip
          echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
          echo "PATH=$HOME/android-sdk/cmdline-tools/latest/bin:$PATH" >> $GITHUB_ENV

      # 5Ô∏è‚É£ Download NDK r17b
      - name: Download NDK r17b
        run: |
          mkdir -p $HOME/android-ndk
          curl -L -o android-ndk.zip https://dl.google.com/android/repository/android-ndk-r17b-linux-x86_64.zip
          unzip -q android-ndk.zip -d $HOME/android-ndk
          rm android-ndk.zip
          echo "NDK_HOME=$HOME/android-ndk/android-ndk-r17b" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$HOME/android-ndk/android-ndk-r17b" >> $GITHUB_ENV

      # 6Ô∏è‚É£ Clean node_modules and cache
      - name: Clean node_modules
        run: |
          rm -rf node_modules
          rm -f package-lock.json
          npm cache clean --force
        working-directory: telon-gateway-app

      # 7Ô∏è‚É£ Ensure Metro config exists
      - name: Setup Metro config
        run: |
          mkdir -p .
          if [ ! -f metro.config.js ]; then
            curl -L -o metro.config.js https://raw.githubusercontent.com/react-native-community/template/main/template/metro.config.js
          fi
        working-directory: telon-gateway-app

      # 8Ô∏è‚É£ Install NPM dependencies
      - name: Install NPM dependencies
        run: npm install
        working-directory: telon-gateway-app

      # 9Ô∏è‚É£ Bundle React Native assets
      - name: Bundle React Native assets
        run: |
          mkdir -p android/app/build/intermediates/assets/release/
          npx react-native bundle \
            --platform android \
            --dev false \
            --entry-file index.js \
            --bundle-output android/app/build/intermediates/assets/release/index.android.bundle \
            --assets-dest android/app/build/intermediates/res/merged/release
        working-directory: telon-gateway-app

      # üîü Generate random keystore
      - name: Generate random Keystore
        run: |
          KEYSTORE_PATH="android/app/my-release-key.keystore"
          if [ ! -f "$KEYSTORE_PATH" ]; then
            PASSWORD=$(openssl rand -base64 12)
            echo "KEYSTORE_PASSWORD=$PASSWORD" >> $GITHUB_ENV
            keytool -genkey -v \
              -keystore "$KEYSTORE_PATH" \
              -alias joolio-key \
              -keyalg RSA -keysize 2048 \
              -validity 10000 \
              -storepass $PASSWORD \
              -keypass $PASSWORD \
              -dname "CN=Mohammad Yazdizadeh, OU=Dev, O=JOOLIO, L=City, S=State, C=US"
          fi
        working-directory: telon-gateway-app

      # 1Ô∏è‚É£1Ô∏è‚É£ Set APK metadata
      - name: Set APK Metadata
        run: |
          MANIFEST_FILE=android/app/src/main/AndroidManifest.xml
          sed -i 's|android:label=".*"|android:label="JOOLIO GSM Gateway"|' $MANIFEST_FILE
          sed -i '/<application / a\
          <meta-data android:name="Author" android:value="Mohammad Yazdizadeh"/>\
          <meta-data android:name="Company" android:value="JOOLIO"/>\
          <meta-data android:name="Website" android:value="https://joolio.me"/>' $MANIFEST_FILE
        working-directory: telon-gateway-app

      # 1Ô∏è‚É£2Ô∏è‚É£ Build APK
      - name: Build Android Release APK
        working-directory: telon-gateway-app/android
        run: |
          chmod +x gradlew
          ./gradlew clean assembleRelease -Pkeystore.password=$KEYSTORE_PASSWORD

      # 1Ô∏è‚É£3Ô∏è‚É£ Copy APK to dist
      - name: Copy APK
        run: |
          mkdir -p $GITHUB_WORKSPACE/dist
          cp app/build/outputs/apk/release/*.apk "$GITHUB_WORKSPACE/dist/JOOLIO GSM Gateway.apk"
        working-directory: telon-gateway-app/android

      # 1Ô∏è‚É£4Ô∏è‚É£ Upload APK
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: $GITHUB_WORKSPACE/dist/JOOLIO\ GSM\ Gateway.apk
